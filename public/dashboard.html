<!DOCTYPE html>
<html>
<head>
  <title>Zoho Desk Live Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 2rem;
      background: #f4f4f4;
    }
    h1 { margin-bottom: 1rem; }
    .kpis {
      display: flex;
      gap: 2rem;
      margin-bottom: 2rem;
    }
    .kpi {
      flex: 1;
      background: #ffffff;
      padding: 1rem;
      border-radius: 1rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      text-align: center;
    }
    .kpi h2 {
      font-size: 1.2rem;
      margin: 0;
      color: #555;
    }
    .kpi p {
      font-size: 2rem;
      margin: 0.5rem 0 0;
      color: #2b2b2b;
    }
    canvas {
      max-width: 500px;
      margin-top: 2rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 2rem;
      background: #fff;
      border-radius: 1rem;
      overflow: hidden;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    th, td {
      padding: 0.75rem;
      border-bottom: 1px solid #ddd;
      text-align: left;
    }
    th {
      background-color: #f2f2f2;
    }
    #updated {
      margin-top: 2rem;
      color: #777;
    }
  </style>
</head>
<body>
  <h1>ðŸ“Š Zoho Desk Live Dashboard</h1>

  <div class="kpis">
    <div class="kpi">
      <h2>Open Tickets</h2>
      <p id="openCount">...</p>
    </div>
    <div class="kpi">
      <h2>High Priority</h2>
      <p id="highCount">...</p>
    </div>
  </div>

  <canvas id="statusChart"></canvas>

  <h2>ðŸ›‘ High Priority Tickets</h2>
  <table>
    <thead>
      <tr>
        <th>Subject</th>
        <th>Contact</th>
        <th>Created Time</th>
      </tr>
    </thead>
    <tbody id="ticketTable"></tbody>
  </table>

  <p id="updated">Last updated: ...</p>

  <script>
    async function loadDashboard() {
      try {
        const response = await fetch("https://zoho-token-server.onrender.com/tickets");
        const result = await response.json();

        const allTickets = result.data || [];
        const highPriority = allTickets.filter(t => t.priority === "High");

        // Show counts
        document.getElementById("openCount").innerText = allTickets.length;
        document.getElementById("highCount").innerText = highPriority.length;

        // Update timestamp
        const now = new Date();
        document.getElementById("updated").innerText = `Last updated: ${now.toLocaleTimeString()}`;

        // Table of high priority tickets
        const table = document.getElementById("ticketTable");
        table.innerHTML = "";
        highPriority.slice(0, 5).forEach(ticket => {
          table.innerHTML += `
            <tr>
              <td>${ticket.subject}</td>
              <td>${ticket.contact?.name || "N/A"}</td>
              <td>${new Date(ticket.createdTime).toLocaleString()}</td>
            </tr>
          `;
        });

        // Group tickets by status
        const statusMap = {};
        allTickets.forEach(ticket => {
          const status = ticket.status || "Unknown";
          statusMap[status] = (statusMap[status] || 0) + 1;
        });

        // Create chart
        const ctx = document.getElementById('statusChart').getContext('2d');
        if (window.statusChart) window.statusChart.destroy(); // Prevent duplicate charts
        window.statusChart = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: Object.keys(statusMap),
            datasets: [{
              label: "Tickets by Status",
              data: Object.values(statusMap),
            }]
          }
        });

      } catch (err) {
        console.error("Dashboard load error:", err);
        document.getElementById("openCount").innerText = "Error";
        document.getElementById("highCount").innerText = "Error";
      }
    }

    loadDashboard();
    setInterval(loadDashboard, 5000);
  </script>
</body>
</html>
